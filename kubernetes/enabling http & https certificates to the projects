**********************************************************************************************************************
***************************HTTP & HTTPS CERTIFCATE AND INGRESS UPDATION***********************************************
**********************************************************************************************************************
  
1.Enable HTTPS with ACM
2.Add HTTP ‚Üí HTTPS redirect
3.Configure root domain (devopswithsiva.info) along with www

OVERVIEW (What We Will Do)

Target architecture:
Internet
 ‚îî‚îÄ‚îÄ ALB
     ‚îú‚îÄ‚îÄ HTTP :80  ‚Üí Redirect ‚Üí HTTPS :443
     ‚îî‚îÄ‚îÄ HTTPS:443 ‚Üí ACM cert ‚Üí EKS service

Domains:
devopswithsiva.info
www.devopswithsiva.info

  STEP 1: Request ACM Certificate (MANDATORY FIRST)

‚ö†Ô∏è ACM certificate MUST be in the same region as ALB
Your ALB is in us-east-1, so ACM must be us-east-1.

1.1 Open ACM (us-east-1)
AWS Console ‚Üí Certificate Manager ‚Üí Request certificate

Choose:
Request a public certificate

1.2 Add Domain Names
Add both:
devopswithsiva.info
www.devopswithsiva.info


Validation method:
DNS validation (recommended)


Key algorithm:
RSA 2048 (default)
Submit.

1.3 Validate Certificate (DNS)
ACM will show two CNAME records.

If your DNS is in Route 53:
Click Create records in Route 53

Done in seconds

If DNS is external:
Copy CNAMEs
Add them manually

1.4 Wait for Status
Wait until:
Status: Issued


STEP 2: Update Ingress for HTTPS + Redirect
Now we update your Ingress YAML.

2.1 Final Production Ingress YAML

Create / update ingress.yaml:



2.2 Apply the Ingress
kubectl apply -f ingress.yaml

2.3 Verify Controller Logs
kubectl logs -f deployment/aws-load-balancer-controller -n kube-system

You should see:
created HTTPS listener
updated listener rules



STEP 3: Configure DNS for ROOT + WWW
3.1 Route 53 Records

In Hosted Zone: devopswithsiva.info
Create two A-Alias records.

Record 1: Root Domain
Field	Value
Name	devopswithsiva.info
Type	A
Alias	Yes
Alias target	ALB DNS
Routing	Simple

Record 2: WWW Domain
Field	Value
Name	www.devopswithsiva.info
Type	A
Alias	Yes
Alias target	ALB DNS
Routing	Simple
‚è± Usually 1‚Äì3 minutes (Route 53)

STEP 4: Verify HTTPS + Redirect
4.1 Test HTTP ‚Üí HTTPS Redirect
curl -I http://www.devopswithsiva.info

Expected:
HTTP/1.1 301 Moved Permanently
Location: https://www.devopswithsiva.info

4.2 Test HTTPS
curl -I https://www.devopswithsiva.info
Expected:
HTTP/2 200

4.3 Browser Test
Open:
https://devopswithsiva.info
https://www.devopswithsiva.info

üîí Green lock icon ‚Üí success

STEP 5: Verify ALB Listeners (Console)
EC2 ‚Üí Load Balancers ‚Üí Your ALB

You should see:
Listener 80 ‚Üí Redirect to HTTPS
Listener 443 ‚Üí Forward to target group

Certificate attached



COMMON MISTAKES (Avoid These)

‚ùå ACM certificate in wrong region
‚ùå Missing root domain in cert
‚ùå Using CNAME instead of Alias for root
‚ùå Not restarting ingress after cert change

FINAL CHECKLIST
Item	Status
ACM issued	‚úÖ
HTTPS listener	‚úÖ
HTTP redirect	‚úÖ
Root domain works	‚úÖ
WWW works	‚úÖ

5. How to Confirm Success (Do This After Creating Records)
aws acm describe-certificate \
  --certificate-arn arn:aws:acm:us-east-1:644209053375:certificate/f0d22358-bade-4639-9bb0-68e4206e61d3 \
  --query "Certificate.Status"

Expected:
"ISSUED"

6. After Certificate Is ISSUED (Next Mandatory Step)
You must ensure your Ingress annotation uses the same certificate ARN:
alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-east-1:644209053375:certificate/f0d22358-bade-4639-9bb0-68e4206e61d3

Then apply:
kubectl apply -f ingress.yaml
ALB will automatically attach the cert.


7. What You Should Do NOW (Exact Order)
Open ACM ‚Üí Create records in Route 53
Wait 1‚Äì2 minutes

Re-run:
aws acm describe-certificate --certificate-arn arn:aws:acm:us-east-1:644209053375:certificate/f0d22358-bade-4639-9bb0-68e4206e61d3 --query Certificate.Status

8. Perfect ‚Äî since the ACM certificate status is now ISSUED, we can complete the final HTTPS + redirect setup and verification cleanly.
I will give you exact steps, in the correct order, with commands and expected results.
STEP 1: Confirm / Fix Ingress for HTTPS (Mandatory)
Your Ingress must explicitly define HTTPS and attach the certificate.

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: frontend-proxy
  namespace: default
  annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP":80},{"HTTPS":443}]'
      alb.ingress.kubernetes.io/ssl-redirect: "443"
      alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-east-1:644209053375:certificate/f0d22358-bade-4639-9bb0-68e4206e61d3
      # HTTP ‚Üí HTTPS Redirect
      alb.ingress.kubernetes.io/actions.ssl-redirect: >
        {"Type":"redirect","RedirectConfig":{"Protocol":"HTTPS","Port":"443","StatusCode":"HTTP_301"}}
spec:
  ingressClassName: alb
  rules:
  # ROOT DOMAIN
  - host: devopswithsiva.info
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: opentelemetry-demo-frontendproxy
            port:
              number: 8080

  # WWW DOMAIN
  - host: www.devopswithsiva.info
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: opentelemetry-demo-frontendproxy
            port:
              number: 8080


9: Recreate the Ingress (Required)
This is critical because the HTTPS listener will not be added unless the Ingress is recreated.

kubectl delete ingress frontend-proxy
kubectl apply -f ingress.yaml
Wait 2‚Äì3 minutes.

10. : Verify ALB Listeners in AWS Console

Go to:
EC2 ‚Üí Load Balancers ‚Üí k8s-default-frontend-*

You MUST see:
Protocol	Port	Action
HTTP	80	Redirect ‚Üí HTTPS:443
HTTPS	443	Forward ‚Üí target group
If HTTPS is missing ‚Üí STOP and tell me.


10. Verify from CLI
10.1 HTTPS should work
curl -I https://www.devopswithsiva.info

Expected:
HTTP/2 200

10.2 HTTP should redirect
curl -I http://www.devopswithsiva.info
Expected:
HTTP/1.1 301 Moved Permanently
Location: https://www.devopswithsiva.info

11.  Verify DNS Resolution (Public)
nslookup www.devopswithsiva.info 8.8.8.8

Should return:
k8s-default-frontend-xxxx.elb.amazonaws.com

12. Final Kubernetes Verification
kubectl get ingress frontend-proxy
kubectl describe ingress frontend-proxy

You should see:
ADDRESS populated
Certificate ARN annotation
HTTPS listed in events



****************************************************************************************************
*******************************************TROUBLE SHOOTING ****************************************
****************************************************************************************************

1. DNS is DEFINITELY in Route 53 ‚úÖ

From:
dig NS devopswithsiva.info +short

You got:
ns-679.awsdns-20.net
ns-1436.awsdns-51.org
ns-1996.awsdns-57.co.uk
ns-434.awsdns-54.com

‚û°Ô∏è These are AWS Route 53 name servers
‚û°Ô∏è Registrar ‚Üí Route 53 delegation is correct
‚û°Ô∏è DNS propagation to Route 53 is already done

2. Certificate is in the CORRECT REGION ‚úÖ
You queried:
aws acm describe-certificate --certificate-arn arn:aws:acm:us-east-1:...

‚úîÔ∏è That means:
Certificate is in us-east-1
Same region as your ALB
Correct for HTTPS

3. 3. Certificate is Still PENDING ‚ùå (Why?)
Certificate.Status = PENDING_VALIDATION


And:
DomainValidationOptions.DomainName:
- www.devopswithsiva.info
- devopswithsiva.info

‚û°Ô∏è ACM is waiting for DNS validation records
‚û°Ô∏è Those records are NOT present in Route 53
This is the only remaining blocker.


1: Confirm DNS Resolution via Public DNS (Authoritative Test)
Run exactly this:
nslookup www.devopswithsiva.info 8.8.8.8

Expected:
Returns your ALB DNS name


2: Force Bypass Local DNS Cache (Guaranteed Test)
Run:
curl -I \
  --resolve www.devopswithsiva.info:443:k8s-default-frontend-6e54782b3e-165510676.us-east-1.elb.amazonaws.com \
  https://www.devopswithsiva.info

Expected:
HTTP/2 200
If you get 200, your HTTPS config is 100% correct.

3: Ensure Ingress Uses the ISSUED Certificate
Verify your Ingress:
kubectl describe ingress frontend-proxy

You must see:
alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-east-1:644209053375:certificate/f0d22358-bade-4639-9bb0-68e4206e61d3
if missing ‚Üí ALB will hang on HTTPS.

If Missing, Fix Immediately
kubectl annotate ingress frontend-proxy \
  alb.ingress.kubernetes.io/certificate-arn=arn:aws:acm:us-east-1:644209053375:certificate/f0d22358-bade-4639-9bb0-68e4206e61d3 \
  --overwrite

4: Ensure HTTPS Listener Exists on ALB

In AWS Console:
EC2 ‚Üí Load Balancers

Select:
k8s-default-frontend-6e54782b3e

Listeners tab
You must see:
Protocol	Port
HTTPS	443
HTTP	80 (redirects to 443)

If HTTPS 443 is missing ‚Üí Ingress was applied before cert was ISSUED.
Fix (Safe)
kubectl delete ingress frontend-proxy
kubectl apply -f ingress.yaml




1. curl -I http://www.devopswithsiva.info
expected output :
HTTP/1.1 200 OK
Date: Wed, 17 Dec 2025 18:06:49 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 76592
Connection: keep-alive
x-powered-by: Next.js
cache-control: private, no-cache, no-store, max-age=0, must-revalidate
etag: "cysb1rgze01n3k"
vary: Accept-Encoding
x-envoy-upstream-service-time: 13
server: envoy

2. curl -I http://www.devopswithsiva.info
expected output:
HTTP/1.1 301 Moved Permanently

3.Ensure HTTPS Listener Exists on ALB
In AWS Console:

EC2 ‚Üí Load Balancers
Select:
k8s-default-frontend-6e54782b3e

Listeners tab
You must see:
Protocol	Port
HTTPS	443
HTTP	80 (redirects to 443)

If HTTPS 443 is missing ‚Üí Ingress was applied before cert was ISSUED.
Fix (Safe)
kubectl delete ingress frontend-proxy
kubectl apply -f ingress.yaml



